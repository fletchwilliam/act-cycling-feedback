<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Canberra Cycling Infrastructure Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div id="map"></div>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="window.appCallbacks.toggleMobileMenu()">
        <span class="hamburger"></span>
    </button>

    <!-- GPS Status Indicator -->
    <div class="gps-status" id="gpsStatus"></div>

    <!-- Style Toggle Button -->
    <button class="style-toggle-btn" id="styleToggleBtn" onclick="window.appCallbacks.toggleStylePanel()">ğŸ¨ Style Layers</button>

    <!-- Layer Styling Panel -->
    <div class="style-panel" id="stylePanel">
        <h3>
            ğŸ¨ Layer Styling
            <button class="close-btn" onclick="window.appCallbacks.toggleStylePanel()">Ã—</button>
        </h3>

        <!-- Map Background Options -->
        <div class="map-style-section">
            <h4>ğŸ—ºï¸ Base Map</h4>
            <div class="basemap-options">
                <div class="basemap-option active" onclick="window.appCallbacks.setBasemap('streets')" id="basemap-streets">Streets</div>
                <div class="basemap-option" onclick="window.appCallbacks.setBasemap('light')" id="basemap-light">Light</div>
                <div class="basemap-option" onclick="window.appCallbacks.setBasemap('dark')" id="basemap-dark">Dark</div>
                <div class="basemap-option" onclick="window.appCallbacks.setBasemap('satellite')" id="basemap-satellite">Satellite</div>
                <div class="basemap-option" onclick="window.appCallbacks.setBasemap('topo')" id="basemap-topo">Terrain</div>
                <div class="basemap-option" onclick="window.appCallbacks.setBasemap('none')" id="basemap-none">None</div>
            </div>

            <!-- Offline Tiles Section -->
            <div class="offline-section">
                <h5>ğŸ“´ Offline Mode</h5>
                <div class="offline-status" id="offlineStatus">
                    <span id="cachedTileCount">0</span> tiles cached
                </div>
                <div class="offline-actions">
                    <button onclick="window.appCallbacks.cacheCurrentArea()" class="btn btn-sm">Cache Area</button>
                    <button onclick="window.appCallbacks.clearTileCache()" class="btn btn-sm btn-secondary">Clear Cache</button>
                </div>
            </div>
        </div>

        <!-- Quick Presets -->
        <div style="margin-bottom: 15px;">
            <label style="font-size: 11px; color: #666; display: block; margin-bottom: 6px;">Quick Presets:</label>
            <div class="style-presets">
                <button onclick="window.appCallbacks.applyStylePreset('default')">Default</button>
                <button onclick="window.appCallbacks.applyStylePreset('highContrast')">High Contrast</button>
                <button onclick="window.appCallbacks.applyStylePreset('subtle')">Subtle</button>
                <button onclick="window.appCallbacks.applyStylePreset('thick')">Thick Lines</button>
                <button onclick="window.appCallbacks.applyStylePreset('thin')">Thin Lines</button>
                <button onclick="window.appCallbacks.applyStylePreset('neon')">Neon</button>
            </div>
        </div>

        <!-- Layer-specific styles -->
        <div id="layerStylesList">
            <p style="color: #888; font-style: italic; font-size: 11px; padding: 10px;">Load datasets to customize their styles</p>
        </div>

        <div class="style-actions">
            <button onclick="window.appCallbacks.resetAllStyles()">Reset All</button>
            <button onclick="window.appCallbacks.applyAllStyles()" class="primary">Apply Styles</button>
        </div>
    </div>

    <!-- Selection Toolbar (Top center) -->
    <div class="selection-toolbar" id="selectionToolbar">
        <button id="panModeBtn" class="active" onclick="window.appCallbacks.setMode('pan')" title="Pan/Navigate">
            ğŸ–ï¸ <span class="btn-text">Pan</span>
        </button>
        <button id="selectModeBtn" onclick="window.appCallbacks.setMode('select')" title="Select features by drawing a rectangle">
            â¬š <span class="btn-text">Select</span>
        </button>
        <button id="feedbackModeBtn" onclick="window.appCallbacks.setMode('feedback')" title="Click on a path to leave feedback">
            ğŸ’¬ <span class="btn-text">Feedback</span>
        </button>
        <button id="gpsBtn" onclick="window.appCallbacks.centerOnLocation()" title="Center on your location">
            ğŸ“ <span class="btn-text">GPS</span>
        </button>
        <div class="divider"></div>
        <button onclick="window.appCallbacks.clearSelection()" title="Clear current selection">
            âœ• <span class="btn-text">Clear</span>
        </button>
        <span class="status" id="selectionStatus">Click "Select Area" to begin</span>
    </div>

    <!-- Feedback Panel (Bottom left) -->
    <div class="feedback-panel" id="feedbackPanel">
        <h3>
            ğŸ’¬ Leave Feedback
            <button class="close-btn" onclick="window.appCallbacks.closeFeedbackPanel()">Ã—</button>
        </h3>

        <div class="feedback-instructions">
            Click on any path to select a location for your feedback.
        </div>

        <div class="feedback-location" id="feedbackLocation" style="display: none;">
            <strong>Location:</strong> <span id="feedbackLocationText"></span>
            <button class="use-gps-btn" onclick="window.appCallbacks.useGPSLocation()" title="Use GPS location">
                ğŸ“ Use GPS
            </button>
        </div>

        <div id="feedbackForm" style="display: none;">
            <div class="feedback-rating">
                <button type="button" class="thumbs-up" onclick="window.appCallbacks.setFeedbackRating('good')" title="Good">ğŸ‘</button>
                <button type="button" class="thumbs-down" onclick="window.appCallbacks.setFeedbackRating('bad')" title="Bad">ğŸ‘</button>
            </div>

            <div class="feedback-form-group">
                <label>Reason for rating *</label>
                <select id="feedbackCategory">
                    <option value="">-- Select a reason --</option>
                    <option value="surface">Surface Quality</option>
                    <option value="safety">Safety Concern</option>
                    <option value="lighting">Lighting</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="feedback-form-group">
                <label>Comment (optional)</label>
                <textarea id="feedbackComment" placeholder="Add any additional details..."></textarea>
            </div>

            <!-- Image Upload Section -->
            <div class="feedback-form-group">
                <label>Photos (optional) <span id="imageCount">0/3 images</span></label>
                <input type="file" id="feedbackImages" accept="image/*" multiple
                    onchange="window.appCallbacks.handleImageSelect(this)"
                    class="image-input">
                <div id="imagePreviewContainer" class="image-preview-container"></div>
                <p class="image-hint">Max 10MB per image. Images will be compressed automatically.</p>
            </div>

            <div class="feedback-form-group">
                <label>Your name (optional)</label>
                <input type="text" id="feedbackName" placeholder="Name">
            </div>

            <div class="feedback-form-group">
                <label>Your email (optional)</label>
                <input type="email" id="feedbackEmail" placeholder="email@example.com">
            </div>

            <div class="feedback-actions">
                <button class="cancel" onclick="window.appCallbacks.resetFeedbackForm()">Cancel</button>
                <button class="download" id="downloadFeedbackBtn" onclick="window.appCallbacks.downloadFeedback()" disabled>ğŸ“¥ Download</button>
            </div>
        </div>
    </div>

    <!-- Analysis Panel (Bottom center) -->
    <div class="analysis-panel" id="analysisPanel">
        <h3>
            ğŸ“Š Selection Analysis
            <button class="close-btn" onclick="window.appCallbacks.closeAnalysisPanel()">Ã—</button>
        </h3>
        <div id="analysisContent">
            <!-- Analysis content will be inserted here -->
        </div>
    </div>

    <!-- Filter Panel (Left side) -->
    <button class="filter-toggle-btn panel-open" id="filterToggleBtn" onclick="window.appCallbacks.toggleFilterPanel()">ğŸ” Filters</button>

    <div class="filter-panel" id="filterPanel">
        <h2>ğŸ” Filter Data</h2>

        <div id="filterContent">
            <p class="no-data-msg">Load datasets to enable filtering</p>
        </div>
    </div>

    <!-- Control Panel (Right side) -->
    <button class="collapse-btn" onclick="window.appCallbacks.togglePanel()">â˜° Panel</button>

    <div class="control-panel" id="controlPanel">
        <h2>ğŸš´ Canberra Infrastructure Map</h2>

        <!-- Layer visibility section (moved to top) -->
        <div class="section-divider">
            <h3>Layer Visibility</h3>

            <div class="layer-toggle">
                <input type="checkbox" id="togglePaths" checked onchange="window.appCallbacks.toggleCoreLayer('paths')">
                <label for="togglePaths">Community Paths</label>
            </div>
            <div class="layer-toggle">
                <input type="checkbox" id="toggleLanes" checked onchange="window.appCallbacks.toggleCoreLayer('lanes')">
                <label for="toggleLanes">On Road Cycle Lanes</label>
            </div>

            <div id="feedbackLayerControls" style="display: none;"></div>

            <h4>Custom Layers</h4>
            <div id="customLayersList">
                <p style="color: #888; font-style: italic; font-size: 11px;">No custom layers added yet</p>
            </div>
        </div>

        <!-- Core datasets section -->
        <h3>Load Datasets</h3>
        <div class="quick-load-section">
            <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Click to load included datasets:</p>
            <div class="quick-load-buttons">
                <button class="quick-load-btn" onclick="window.appCallbacks.quickLoadDataset('community-path')">Community Path</button>
                <button class="quick-load-btn" onclick="window.appCallbacks.quickLoadDataset('pedestrian-crossings')">Pedestrian Crossings</button>
                <button class="quick-load-btn" onclick="window.appCallbacks.quickLoadDataset('onroad-cycle-lane')">Onroad Cycle Lane</button>
            </div>
        </div>

        <!-- Add custom layer section -->
        <div class="add-layer-section">
            <h3>â• Add Custom Layer</h3>
            <div class="preset-buttons">
                <button class="preset-btn" onclick="window.appCallbacks.applyPreset('crossings')">ğŸš¶ Crossings</button>
                <button class="preset-btn" onclick="window.appCallbacks.applyPreset('bikeracks')">ğŸ…¿ï¸ Bike Racks</button>
                <button class="preset-btn" onclick="window.appCallbacks.applyPreset('traffic')">ğŸš¦ Traffic Lights</button>
                <button class="preset-btn" onclick="window.appCallbacks.applyPreset('custom')">ğŸ“ Custom</button>
            </div>
            <div class="add-layer-form">
                <input type="text" id="layerName" placeholder="Layer name (e.g., Pedestrian Crossings)">
                <div class="form-row">
                    <label>Color:</label>
                    <input type="color" id="layerColor" value="#e91e63">
                    <label>Type:</label>
                    <select id="layerType">
                        <option value="auto">Auto-detect</option>
                        <option value="point">Points</option>
                        <option value="line">Lines</option>
                        <option value="polygon">Polygons</option>
                    </select>
                </div>
                <input type="file" id="customLayerFile" accept=".geojson,.json">
                <button class="btn btn-primary" onclick="window.appCallbacks.addCustomLayer()">Add Layer</button>
            </div>
        </div>

        <!-- Load Feedback section -->
        <div class="add-layer-section">
            <h3>ğŸ’¬ Load Feedback</h3>
            <p style="font-size: 11px; color: #666; margin-bottom: 8px;">Load feedback GeoJSON files to display on the map</p>
            <input type="file" id="feedbackFile" accept=".geojson,.json" multiple onchange="window.appCallbacks.loadFeedbackFiles(this)">
            <div id="feedbackLayerInfo" style="display: none; margin-top: 8px; font-size: 11px; color: #333;"></div>
        </div>

        <!-- Legend -->
        <div class="legend">
            <h3>Legend - Community Paths</h3>
            <div class="legend-item">
                <div class="legend-line" style="background: #e41a1c;"></div>
                <span>Cyclepath</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #377eb8;"></div>
                <span>Separated Cyclepath</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #4daf4a;"></div>
                <span>Footpath</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #984ea3;"></div>
                <span>Shared Path</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #999999;"></div>
                <span>Other</span>
            </div>

            <h3>Legend - Cycle Lanes</h3>
            <div class="legend-item">
                <div class="legend-line" style="background: #ff7f00; height: 6px;"></div>
                <span>Green Pavement Paint</span>
            </div>
            <div class="legend-item">
                <div class="legend-line" style="background: #a65628; height: 6px;"></div>
                <span>Standard Pavement</span>
            </div>

            <div id="customLegend"></div>
        </div>

        <!-- Statistics -->
        <div class="stats" id="stats">
            <h4>ğŸ“Š Statistics</h4>
            <p style="color: #888; font-style: italic;">Load data to see statistics</p>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading...</div>
    </div>

    <script type="module" src="js/app.js"></script>
</body>
</html>
